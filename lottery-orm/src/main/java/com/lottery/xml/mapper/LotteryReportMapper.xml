<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lottery.orm.dao.LotteryReportMapper">
  <resultMap id="WinningReportMap" type="com.lottery.orm.dto.WinningReportDto">
    <result column="ACCOUNTID" jdbcType="INTEGER" property="accountId" />
    <result column="USERNAME" jdbcType="VARCHAR" property="userName" />
    <result column="SUPUSERNAME" jdbcType="VARCHAR" property="supUserName" />
    <result column="TRADECOUNT" jdbcType="INTEGER" property="tradeCount" />
    <result column="ORDERAMOUNT" jdbcType="DECIMAL" property="orderAmount" />
    <result column="ACTUALAMOUNT" jdbcType="DECIMAL" property="actualAmount" />
    <result column="RATIO" jdbcType="DECIMAL" property="ratio" />
    <result column="RETURNAMOUNT" jdbcType="DECIMAL" property="returnAmount" />
    <result column="COMMISIONAMOUNT" jdbcType="DECIMAL" property="commisionAmount" />
  </resultMap>
  <resultMap id="TradeReportMap" type="com.lottery.orm.dto.TradeReportDto">
    <result column="ACCOUNTID" jdbcType="INTEGER" property="accountId" />
    <result column="LOTTERYTERM" jdbcType="VARCHAR" property="lotteryTerm" />
    <result column="ORDERTIME" jdbcType="TIMESTAMP" property="orderTime" />
    <result column="ENDTIME" jdbcType="TIMESTAMP" property="endTime" />
    <result column="ORDERAMOUNT" jdbcType="DECIMAL" property="orderAmount" />
    <result column="ACTUALAMOUNT" jdbcType="DECIMAL" property="actualAmount" />
    <result column="ACCOUNTAMOUNT" jdbcType="DECIMAL" property="accountAmount" />
  </resultMap>
  <resultMap id="InoutReportMap" type="com.lottery.orm.dto.InoutReportDto">
    <result column="ACCOUNTID" jdbcType="INTEGER" property="accountId" />
    <result column="TRADEAMOUNT" jdbcType="DECIMAL" property="tradeAmount" />
    <result column="ACCOUNTAMOUNT" jdbcType="DECIMAL" property="accountAmount" />
    <result column="INPUTTIME" jdbcType="TIMESTAMP" property="inputTime" />
    <result column="REMARK" jdbcType="VARCHAR" property="remark" />
  </resultMap>
  <resultMap id="HistoryOrderMap" type="com.lottery.orm.dto.HistoryOrderDto">
    <result column="ORDERID" jdbcType="INTEGER" property="orderId" />
    <result column="ORDERTIME" jdbcType="TIMESTAMP" property="orderTime" />
    <result column="ROUNDID" jdbcType="INTEGER" property="roundId" />
    <result column="ITEMNAMECN" jdbcType="VARCHAR" property="itemNameCN" />
    <result column="DETAILAMOUNT" jdbcType="DECIMAL" property="detailAmount" />
    <result column="ACTUALAMOUNT" jdbcType="DECIMAL" property="actualAmount" />
  </resultMap>
  
  <select id="selectByWinningReport" resultMap="WinningReportMap">
    select 
    a.ACCOUNTID, a.USERNAME, a.SUPUSERNAME, count(*) as TRADECOUNT, SUM(ORDERAMOUNT) as ORDERAMOUNT, SUM(ACTUALAMOUNT) as ACTUALAMOUNT, AVG(a.RATIO) as RATIO, SUM(PRIZEAMOUNT-ACTUALAMOUNT) as RETURNAMOUNT, SUM(COMMISIONAMOUNT) as COMMISIONAMOUNT 
    from account_detail a, lottery_order o
    where a.ACCOUNTID = o.ACCOUNTID 
	<if test="startTime != null and endTime != null">
	and Date(PRIZETIME) between #{startTime,jdbcType=TIMESTAMP} and #{endTime,jdbcType=TIMESTAMP}
	</if>
	<if test="startTime != null and endTime == null">
	and Date(PRIZETIME) <![CDATA[>=]]> #{startTime,jdbcType=TIMESTAMP}
	</if>
	<if test="startTime == null and endTime != null">
	and Date(PRIZETIME) <![CDATA[<=]]> #{endTime,jdbcType=TIMESTAMP}
	</if>
    group by a.ACCOUNTID
	<if test="beginRow != null and pageSize !=null">
	limit #{beginRow,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
	</if>
  </select>
  <select id="selectByTradeReport" resultMap="TradeReportMap">
    select 
    o.ACCOUNTID, LOTTERYTERM, ORDERTIME, ENDTIME, ORDERAMOUNT, ACTUALAMOUNT, ACCOUNTAMOUNT
    from lottery_order o, lottery_round r
    where o.ROUNDID = R.ROUNDID 
	<if test="startTime != null and endTime != null">
	and Date(ENDTIME) between #{startTime,jdbcType=TIMESTAMP} and #{endTime,jdbcType=TIMESTAMP}
	</if>
	<if test="startTime != null and endTime == null">
	and Date(ENDTIME) <![CDATA[>=]]> #{startTime,jdbcType=TIMESTAMP}
	</if>
	<if test="startTime == null and endTime != null">
	and Date(ENDTIME) <![CDATA[<=]]> #{endTime,jdbcType=TIMESTAMP}
	</if>
	<if test="accountId != null">
	 and o.ACCOUNTID = #{accountId,jdbcType=INTEGER}
	</if>
	 order by ORDERTIME desc
	 <if test="beginRow != null and pageSize !=null">
	limit #{beginRow,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
	</if>
  </select>
  <select id="selectByInoutReport" resultMap="InoutReportMap">
    select 
    ACCOUNTID, TRADEAMOUNT, ACCOUNTAMOUNT, INPUTTIME, REMARK
    from trade_info t
    where TRADETYPE in ('Inout')
	<if test="startTime != null and endTime != null">
		and Date(INPUTTIME) between #{startTime,jdbcType=TIMESTAMP} and #{endTime,jdbcType=TIMESTAMP}
	</if>
	<if test="startTime != null and endTime == null">
	and Date(INPUTTIME) <![CDATA[>=]]> #{startTime,jdbcType=TIMESTAMP}
	</if>
	<if test="startTime == null and endTime != null">
	and Date(INPUTTIME) <![CDATA[<=]]> #{endTime,jdbcType=TIMESTAMP}
	</if>
	<if test="accountId != null">
		and t.ACCOUNTID = #{accountId,jdbcType=INTEGER}
	</if>
	order by INPUTTIME desc
	<if test="beginRow != null and pageSize !=null">
	limit #{beginRow,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
	</if>
  </select>
  
  <select id="selectByHistoryOrder" resultMap="HistoryOrderMap">
    select 
    o.ORDERID, ORDERTIME, ROUNDID, i.ITEMNAMECN, d.DETAILAMOUNT, d.ACTUALAMOUNT 
    from lottery_order o inner join lottery_order_detail d on o.ORDERID=d.ORDERID left join lottery_item i on d.ITEMNO=i.ITEMNO
    where o.ACCOUNTID = #{accountId,jdbcType=INTEGER}
	<if test="startTime != null and endTime != null">
	and Date(ORDERTIME) between #{startTime,jdbcType=TIMESTAMP} and #{endTime,jdbcType=TIMESTAMP}
	</if>
	<if test="startTime != null and endTime == null">
	and Date(ORDERTIME) <![CDATA[>=]]> #{startTime,jdbcType=TIMESTAMP}
	</if>
	<if test="startTime == null and endTime != null">
	and Date(ORDERTIME) <![CDATA[<=]]> #{endTime,jdbcType=TIMESTAMP}
	</if>
	order by o.ORDERID, ORDERTIME
	<if test="beginRow != null and pageSize !=null">
	limit #{beginRow,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
	</if>
  </select>
</mapper>